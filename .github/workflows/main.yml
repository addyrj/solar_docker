name: CI - Docker Build & Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set environment variables (Match your docker-compose)
      - name: Set environment variables
        run: |
          echo "MYSQL_ROOT_PASSWORD=root123" >> $GITHUB_ENV
          echo "MYSQL_DATABASE=iot_solar" >> $GITHUB_ENV
          echo "DB_HOST=solar_mysql" >> $GITHUB_ENV
          echo "DB_USER=root" >> $GITHUB_ENV
          echo "DB_PASSWORD=root123" >> $GITHUB_ENV
          echo "DB_NAME=iot_solar" >> $GITHUB_ENV
          echo "DB_DIALECT=mysql" >> $GITHUB_ENV
          echo "BACKEND_PORT=5000" >> $GITHUB_ENV
          echo "ROOT_ROUTES=/api" >> $GITHUB_ENV
          echo "SALT_ROUND=10" >> $GITHUB_ENV
          echo "SECRET_KEY_ADMIN_AUTH_TOKEN=testtoken123" >> $GITHUB_ENV
          echo "SECRET_KEY_ADMIN_PASSWORD=testpass123" >> $GITHUB_ENV
          echo "MQTT_HOST=your_mqtt_host" >> $GITHUB_ENV
          echo "MQTT_USERNAME=username" >> $GITHUB_ENV
          echo "MQTT_PASSWORD=password" >> $GITHUB_ENV
          echo "MQTT_TOPIC=test/topic" >> $GITHUB_ENV
          echo "CORS_ORIGIN=*" >> $GITHUB_ENV
          echo "REACT_APP_BASE_URL=http://localhost:5001/api" >> $GITHUB_ENV
          echo "REACT_APP_IMAGE_URL=http://localhost:5001" >> $GITHUB_ENV

      # 3. Setup Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4. Build MySQL image
      - name: Build MySQL Image
        run: |
          docker build -t solar_mysql ./db

      # 5. Build Backend image
      - name: Build Backend Image
        run: |
          docker build -t solar_backend ./server

      # 6. Build Frontend image (React)
      - name: Build Frontend Image
        run: |
          docker build -t solar_frontend ./frontend \
            --build-arg REACT_APP_BASE_URL=${REACT_APP_BASE_URL} \
            --build-arg REACT_APP_IMAGE_URL=${REACT_APP_IMAGE_URL}

      # 7. Start docker-compose and test if all containers work
      - name: Run Docker Compose
        run: |
          docker-compose up --build -d
          sleep 10
          docker ps

      # 8. Stop and clean containers after test
      - name: Clean up
        if: always()
        run: |
          docker-compose down
