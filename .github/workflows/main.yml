name: CI - Docker Build & Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Create .env file for docker-compose
      - name: Create .env file
        run: |
          cat > .env << EOF
          MYSQL_ROOT_PASSWORD=root123
          MYSQL_DATABASE=iot_solar
          DB_HOST=mysql
          DB_USER=root
          DB_PASSWORD=root123
          DB_NAME=iot_solar
          DB_DIALECT=mysql
          BACKEND_PORT=5000
          ROOT_ROUTES=/api
          SALT_ROUND=10
          SECRET_KEY_ADMIN_AUTH_TOKEN=testtoken123
          SECRET_KEY_ADMIN_PASSWORD=testpass123
          MQTT_HOST=mqtt.example.com
          MQTT_USERNAME=username
          MQTT_PASSWORD=password
          MQTT_TOPIC=test/topic
          CORS_ORIGIN=*
          REACT_APP_BASE_URL=http://localhost:5001/api
          REACT_APP_IMAGE_URL=http://localhost:5001
          EOF

      # 3. Display .env file (for debugging)
      - name: Display .env file
        run: cat .env

      # 4. Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 5. Build and start services with docker-compose
      - name: Build and Start Services
        run: |
          docker compose up --build -d
          echo "Waiting for services to be healthy..."
          sleep 30

      # 6. Check container status
      - name: Check Running Containers
        run: |
          echo "=== Docker Containers ==="
          docker ps -a
          echo ""
          echo "=== MySQL Container Logs ==="
          docker logs solar_mysql --tail 50
          echo ""
          echo "=== Backend Container Logs ==="
          docker logs solar_backend --tail 50
          echo ""
          echo "=== Frontend Container Logs ==="
          docker logs solar_frontend --tail 50

      # 7. Test MySQL connection
      - name: Test MySQL Connection
        run: |
          echo "Testing MySQL connection..."
          docker exec solar_mysql mysqladmin ping -h localhost -u root -proot123 || true

      # 8. Test Backend API
      - name: Test Backend API
        run: |
          echo "Testing Backend API..."
          curl -f http://localhost:5001/api || echo "Backend not responding yet"
          
      # 9. Test Frontend
      - name: Test Frontend
        run: |
          echo "Testing Frontend..."
          curl -f http://localhost:3000 || echo "Frontend not responding yet"

      # 10. Check if all containers are still running
      - name: Verify Containers Still Running
        run: |
          echo "=== Final Container Status ==="
          docker ps
          
          # Check if all expected containers are running
          if [ $(docker ps --filter "name=solar_mysql" --filter "status=running" -q | wc -l) -eq 0 ]; then
            echo "❌ MySQL container is not running"
            exit 1
          fi
          
          if [ $(docker ps --filter "name=solar_backend" --filter "status=running" -q | wc -l) -eq 0 ]; then
            echo "❌ Backend container is not running"
            exit 1
          fi
          
          if [ $(docker ps --filter "name=solar_frontend" --filter "status=running" -q | wc -l) -eq 0 ]; then
            echo "❌ Frontend container is not running"
            exit 1
          fi
          
          echo "✅ All containers are running successfully!"

      # 11. Clean up
      - name: Stop and Remove Containers
        if: always()
        run: |
          echo "Cleaning up..."
          docker compose down -v
          docker system prune -f