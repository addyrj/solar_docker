name: CI - Docker Build & Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Create .env file for docker-compose
      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          MYSQL_ROOT_PASSWORD=root123
          MYSQL_DATABASE=iot_solar
          DB_HOST=mysql
          DB_USER=root
          DB_PASSWORD=root123
          DB_NAME=iot_solar
          DB_DIALECT=mysql
          BACKEND_PORT=5000
          ROOT_ROUTES=/api
          SALT_ROUND=10
          SECRET_KEY_ADMIN_AUTH_TOKEN=testtoken123
          SECRET_KEY_ADMIN_PASSWORD=testpass123
          MQTT_HOST=mqtt.example.com
          MQTT_USERNAME=username
          MQTT_PASSWORD=password
          MQTT_TOPIC=test/topic
          CORS_ORIGIN=*
          REACT_APP_BASE_URL=http://localhost:5001/api
          REACT_APP_IMAGE_URL=http://localhost:5001
          EOF

      # 3. Display .env file (for debugging)
      - name: Display .env file
        run: cat .env

      # 4. Verify docker-compose file exists
      - name: Verify docker-compose.yaml exists
        run: |
          if [ ! -f "docker-compose.yaml" ]; then
            echo "âŒ docker-compose.yaml not found!"
            exit 1
          fi
          echo "âœ… docker-compose.yaml found"

      # 5. Build and start services with docker-compose
      - name: Build and Start Services
        run: |
          docker compose up --build -d
          echo "âœ… Docker Compose started"

      # 6. Wait for services to be ready
      - name: Wait for services
        run: |
          echo "â³ Waiting 60 seconds for all services to initialize..."
          sleep 60

      # 7. Check container status
      - name: Check Running Containers
        if: always()
        run: |
          echo "=== Docker Containers Status ==="
          docker compose ps
          echo ""
          docker ps -a

      # 8. Show MySQL logs
      - name: Show MySQL Logs
        if: always()
        run: |
          echo "=== MySQL Container Logs (last 100 lines) ==="
          docker logs solar_mysql --tail 100 || echo "Could not get MySQL logs"

      # 9. Show Backend logs
      - name: Show Backend Logs
        if: always()
        run: |
          echo "=== Backend Container Logs (last 100 lines) ==="
          docker logs solar_backend --tail 100 || echo "Could not get Backend logs"

      # 10. Show Frontend logs
      - name: Show Frontend Logs
        if: always()
        run: |
          echo "=== Frontend Container Logs (last 100 lines) ==="
          docker logs solar_frontend --tail 100 || echo "Could not get Frontend logs"

      # 11. Test MySQL connection
      - name: Test MySQL Connection
        run: |
          echo "ðŸ§ª Testing MySQL connection..."
          docker exec solar_mysql mysqladmin ping -h localhost -u root -proot123 && echo "âœ… MySQL is responding" || echo "âš ï¸ MySQL not responding"

      # 12. Test Backend API (non-failing)
      - name: Test Backend API
        run: |
          echo "ðŸ§ª Testing Backend API at http://localhost:5001/api..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api || echo "000")
          echo "HTTP Response Code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Backend is responding (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Backend returned HTTP $HTTP_CODE or is not accessible"
          fi
          
      # 13. Test Frontend (non-failing)
      - name: Test Frontend
        run: |
          echo "ðŸ§ª Testing Frontend at http://localhost:3000..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
          echo "HTTP Response Code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Frontend is responding (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Frontend returned HTTP $HTTP_CODE or is not accessible"
          fi

      # 14. Verify all containers are running
      - name: Verify Containers Still Running
        run: |
          echo "=== Final Container Status ==="
          docker ps
          
          MYSQL_RUNNING=$(docker ps --filter "name=solar_mysql" --filter "status=running" -q | wc -l)
          BACKEND_RUNNING=$(docker ps --filter "name=solar_backend" --filter "status=running" -q | wc -l)
          FRONTEND_RUNNING=$(docker ps --filter "name=solar_frontend" --filter "status=running" -q | wc -l)
          
          echo "MySQL container running: $MYSQL_RUNNING"
          echo "Backend container running: $BACKEND_RUNNING"
          echo "Frontend container running: $FRONTEND_RUNNING"
          
          if [ "$MYSQL_RUNNING" -eq 0 ]; then
            echo "âŒ MySQL container is not running"
            exit 1
          fi
          
          if [ "$BACKEND_RUNNING" -eq 0 ]; then
            echo "âŒ Backend container is not running"
            exit 1
          fi
          
          if [ "$FRONTEND_RUNNING" -eq 0 ]; then
            echo "âŒ Frontend container is not running"
            exit 1
          fi
          
          echo "âœ… All 3 containers are running successfully!"
          echo "ðŸŽ‰ CI Build PASSED!"

      # 15. Clean up
      - name: Stop and Remove Containers
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          docker compose down -v --remove-orphans
          echo "âœ… Cleanup complete"